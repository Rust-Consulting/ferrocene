# SPDX-License-Identifier: MIT OR Apache-2.0
# SPDX-FileCopyrightText: The Ferrocene Developers

FROM --platform=linux/amd64 ubuntu:24.04

RUN apt-get update \
    # Update all the dependencies
    && DEBIAN_FRONTEND=noninteractive apt-get upgrade -y \
    # Install required packages
    && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        git \
        build-essential \
        gcc-multilib \
        ninja-build \
        openssh-client \
        file \
        gdb \
        curl \
        ca-certificates \
        python3 \
        libedit-dev \
        libssl-dev \
        zlib1g-dev \
        moreutils \
        cmake \
        python-is-python3 \
        pipx \
        # Needed by the `commit-checks` CI job:
        llvm-17-tools \
        llvm-17-dev \
        unzip \
    # Remove files that are not useful in the final image, and can be
    # regenerated by running `apt-get update`
    && rm -rf /var/lib/apt/lists/*

# Install AWS CLI from the published binaries, as no source tarball is provided
# and the version in the Ubuntu 24.04 is a snap.
RUN curl -Lo /tmp/awscli.zip https://awscli.amazonaws.com/awscli-exe-linux-x86_64-2.12.4.zip \
    && echo "0556162145e68889a27f835307b9dad56de60fda4256d2e246e9699f24535a08  /tmp/awscli.zip" | sha256sum -c \
    && unzip -q -d /tmp/awscli /tmp/awscli.zip \
    && /tmp/awscli/aws/install \
    && rm -rf /tmp/awscli /tmp/awscli.zip

# Tell programs relying on the system language (like Python) to use UTF-8.
ENV LANG=C.UTF-8

RUN mkdir /home/ci \
    && deluser --remove-home ubuntu \
    && addgroup --gid 1000 ci \
    && addgroup --gid 1001 ci-usergroup \
    && adduser --home /home/ci --uid 1000 --gid 1000 --gecos "" --disabled-password ci \
    && adduser --uid 1001 --gid 1001 --gecos "" --disabled-password ci-user \
    && chown -R ci: /home/ci
USER ci
WORKDIR /home/ci

# We prefer uv over other solutions, it's in Rust and fast
ENV PATH="/home/ci/.local/bin:$PATH"
RUN pipx install uv
# Setup the venv
COPY requirements.txt /tmp/requirements.txt
RUN uv venv \
    && uv pip sync /tmp/requirements.txt
ENV PATH="/home/ci/.venv/bin:$PATH"
