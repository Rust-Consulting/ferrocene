# SPDX-License-Identifier: MIT OR Apache-2.0
# SPDX-FileCopyrightText: The Ferrocene Developers

FROM ubuntu:23.10

RUN apt-get update \
    # Update all the dependencies
    && DEBIAN_FRONTEND=noninteractive apt-get upgrade -y \
    # Install required packages
    && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        git \
        build-essential \
        gcc-multilib \
        ninja-build \
        openssh-client \
        file \
        gdb \
        curl \
        ca-certificates \
        python3 \
        python3-venv \
        libedit-dev \
        libssl-dev \
        zlib1g-dev \
        moreutils \
        cmake \
        python-is-python3 \
        reuse \
        # Needed by the `commit-checks` CI job:
        llvm-17-tools \
        llvm-17-dev \
        # Needed to install AWS CLI during the build:
        unzip \
    # Remove files that are not useful in the final image, and can be
    # regenerated by running `apt-get update`
    && rm -rf /var/lib/apt/lists/*

# Install AWS CLI from the published binaries, as no source tarball is provided
# and the version in the Ubuntu 22.04 archive is too old and doesn't support
# `aws ecr get-login-password`.
# TODO / FIXME: awscli version 2.12.0 is availabole as a deb package for 
# Ubuntu 23.10 which means we can remove this download and just install via
# run apt-get.
# https://ubuntu.pkgs.org/23.10/ubuntu-universe-amd64/awscli_2.12.0-1_all.deb.html
RUN curl -Lo /tmp/awscli.zip https://awscli.amazonaws.com/awscli-exe-linux-x86_64-2.12.4.zip \
    && echo "0556162145e68889a27f835307b9dad56de60fda4256d2e246e9699f24535a08  /tmp/awscli.zip" | sha256sum -c \
    && unzip -q -d /tmp/awscli /tmp/awscli.zip \
    && /tmp/awscli/aws/install \
    && rm -rf /tmp/awscli /tmp/awscli.zip

# Tell programs relying on the system language (like Python) to use UTF-8.
ENV LANG=C.UTF-8

RUN mkdir /home/ci \
    && deluser --remove-home --group ubuntu \
    && addgroup --gid 1000 ci \
    && addgroup --gid 1001 ci-usergroup \
    && adduser --home /home/ci --uid 1000 --gid 1000 --gecos "" --disabled-password ci \
    && adduser --uid 1001 --gid 1001 --gecos "" --disabled-password ci-user \
    && chown -R ci: /home/ci
USER ci
WORKDIR /home/ci
